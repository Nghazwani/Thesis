\section{intro}

The last type of PF particle candidates to be reconstructed are hadrons. which are composite particles made up of quarks and gluons are stopped by the HCAL.
Some hadrons start showering in ECAL, and as mentioned in previous chapter that ECAL is well calibrated for EM particles, but not for hadrons.

a key feature of the hadronic showers is the fluctuation from event to event even in showers generated by the same incident particle . (the fluctuation could be in the fraction of energy lost (as binding energy), paritcle type, particle multiplicity) 

To accurately reconstruct hadron candidates, a correction for HCAL cluster energy needs to be applied after ECAL cluster calibration. (which is important for analysis) 

This chapter similarly to the previous one presents the used ML method and datasets in performing the PF HCAL cluster energy regression.

\section{GNN} %source

GNN is a type of NN that is used to process data that can be represented as graphs. comparing to some kinds of NN, GNN can be applied on sparse data (thinly scattered like rechits). A graph consists of nodes which represent features of the objects, in our case will be represented by rechits and edges reflect the relationship between the rechit. information in GNN can be shared between neighbors. in our case seeing how rechits are connected, in clusters that represent one particle. (find related figure).

the vector feature of each node is transformed into messages (using dense layers) that will be sent to the neighbors (message passing) in this way each node will learn about its neighbors and itself. (add picture that shows massage passing) 



\section{datasets description}

The second part of the thesis focuses on the calibration charged hadrons pf clusters.
The data samples used for this calibration are single Pion gun.
They are centrally produced (reconstructed) MC samples, under 126X %CMSSW_12_6_4
, Run3 winter23, conditions. These samples are also available through DAS web page and they cover two ranges of E 2-200 GeV,200-500 GeV.  

Before using the data in training ML model, we need to prepare it according to the types of hadronic showers.
We have where H-hadrons are when the pion start showering in HCAL meaning the particles do not start a nuclear interaction in ECAL hadronic shower) and EH-hadrons are particles that start showering in ECAL. 


\section{PF cluster regression using DRN}

Hadronic showers in the CMS detector have both electromagnetic and hadronic components. These showers are not fully contained in the ECAL but extend to HCAL. The reconstructed energy of hadrons is the sum of all reconstructed hits (offline, PF reconstruct the RAW data) from the ECAL and HCAL. 

% move the details of the DRN here. 

Cluster Energy is reconstructed using both conventional method (chi square) and dynamic reduction network(based on Graph neural network which mentioned in ML ch).Then for a given bin of true energy we fit the distribution of total RAW energy with Gaussian then we obtain: mu (mean energy) and std deviation.

Finally, we calculate: Resolution: (std/mu) which represent a measure of accuracy HCAL 
and Response of HCAL:  [(mu/E true) -1] : which is measurement of precision of HCAL 
(we can see that is not linear, another reason why the calibration of HCAL is not easy).

%\subsection{DRN}
% DRN details 
DRN architecture overview:
1. input: Rechits => inputNet (FCNN) *Fully Connected Network*
2. => Graph Generation (KNN) => EdgeConv => calculate edge weights => graph clustering (Graclus) => graph pooling (add)
3. Global pool (max) 4. outputNet => output (E pred).

layers: input 3, aggregation 2, output 2, message passing2.

input: rechit positions, E rechit energy corresponding to each rechit (rechits are selected after dR matching)

Different training target used: ratio, ratio flip, log (ratio flip), trueE

Other variable used in the training: batch size: 400, number of epochs trained 100, constant learning rate of 0.0001.

(next move on to talk about energy corrections using DRN) loss function:  [(E true- E pre)^2/E true]

80\% of the dataset used for training and 20\% for validation.

\section{results}
we present the results of response and resolution (from DRN vs Chi2) in  both Barrel region and endcap region.

\subsection{EH Hadrons}
the presented results are for the training target ratioflip
\include{./plots_tex/target_ratioflip_EH_plots}
\include{./plots_tex/target_logratioflip_EH_plots}
\include{./plots_tex/target_ratio_EH_plots}
\include{./plots_tex/target_trueE_EH_plots}

\subsection{H hadrons}
\include{./plots_tex/target_ratioflip_H_plots}
\include{./plots_tex/target_logratioflip_H_plots}
\include{./plots_tex/target_ratio_H_plots}
\include{./plots_tex/target_trueE_H_plots}
