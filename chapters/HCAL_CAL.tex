%\section{intro}

The last type of PF particle candidates to be reconstructed are hadrons. Hadrons are composite particles made up of quarks and gluons are stopped by the HCAL. Some hadrons start showering in ECAL, however as seen in the previous chapter that ECAL is well calibrated for EM particles (electrons and photons), but not for hadrons.

a key feature of the hadronic showers is the fluctuation in showers generated by the same incident particle. these fluctuations from event to event could be in the fraction of energy lost as binding energy, particle type, particle multiplicity.

To accurately reconstruct hadron candidates, a correction for HCAL cluster energy needs to be applied after ECAL cluster calibration. This step is important for physics analysis since as mentioned before that pf candidates are used in reconstructing higher level physics objects.

This chapter similarly to the previous one introduced the ML method and datasets used in performing the PF HCAL cluster energy regression.  

\section{GNN} %source

Graph neural network (GNN) is a type of NN that is used to process data that can be represented as graphs. Comparing to some other kinds of NN, GNN can be applied on thinly scattered data (sparse data).

A graph in general consists of nodes and edges. Nodes represent the objects; in our case this is the HCAL rechits and edges reflect the relationship between the rechits. Information in GNN can be shared between neighbors. in our case seeing how rechits are connected, in clusters that represent one particle.

The featuresâ€™ vector of each node is transformed into messages using dense layers that will be sent to the neighbors through message passing.  in this way each node will learn about its neighbors and itself. (insert here related figure source) 


\section{datasets description}

The second part of the thesis focuses on the correction of charged hadrons pf clusters for Run3 winter23. The data samples used for this calibration are single Pion gun. They are centrally produced MC samples, and reconstructed under 126X, CMSSW 12.6.4, conditions. These samples were also available through DAS web page and cover ranges of energy 2-200 GeV,200-500 GeV.

Before using the data in training ML model, we need to prepare it according to the types of hadronic showers. First type are H-hadrons where the pion starts showering in HCAL meaning the particles do not have a nuclear interaction in ECAL. Second type are EH-hadrons are Pions start showering in ECAL and continue to HCAL.  

\section{PF cluster regression using DRN}

The calibration here is done using a dynamic reduction network (DRN). DRN is a ML method based on GNN %(Paper source , talk source).  
The DRN model maps the input features onto a higher dimensional latent space and adds clustering and pooling steps to aggregate information. The input features used are the energies (E) and (x,y,z) coordinates of individual cells (rechits - selected after dR matching).

architecture overview: (insert here the relate figure) 
step1: (Rechits) are the input for inputNet (FCNN - Fully Connected Network). 
step2:  Graph Generation (KNN), EdgeConv, calculate edge weights, graph clustering (Graclus), graph pooling (add). 
Step3: Global pool (max).  
step 4: output of outputNet is (E pred, the energy reconstructed using DRN weights).

The target used for training the model is correction factor:  true energy of the generated / raw pf cluster energy that is reconstructed using detector level calibration. Other details related to the training are: the number of layers for: input 3, aggregation 2, output 2, message passing 2. batch size: 400, number of epochs trained 100, constant learning rate of 0.0001. The Loss functions used during training is defined as: (target-prediction) ^2 / target. We can check the performance of the DRN training by plotting: loss vs epoch.

To test the DRN model results, we apply the model on 20\% of the dataset. Then calculate two quantities: first, average of calibrated E response = [ true energy (E true) - calibrated energy (E pre)] / true energy in GeV for different true energy bins in specific eta range. The thinner the peak the better. 
Second, Energy resolution = std of (calibrated E response) / true energy. These quantities are calculated for different regions (with different eta range): Barrel region. Endcap within the tracker region. Endcap outside the tracker region. (pt range from 1-300 GeV)

\section{results}
we present the results of response and resolution (from DRN vs Chi2) in  both Barrel region and endcap region.

\subsection{EH Hadrons}
the presented results are for the training target ratioflip
\include{./plots_tex/target_ratioflip_EH_plots}
\include{./plots_tex/target_logratioflip_EH_plots}
\include{./plots_tex/target_ratio_EH_plots}
\include{./plots_tex/target_trueE_EH_plots}

\subsection{H hadrons}
\include{./plots_tex/target_ratioflip_H_plots}
\include{./plots_tex/target_logratioflip_H_plots}
\include{./plots_tex/target_ratio_H_plots}
\include{./plots_tex/target_trueE_H_plots}
